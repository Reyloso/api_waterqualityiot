{% extends "base/base.html" %}
{% load static %}
{% block contenido %}
<div class="container" style="margin-top: 20px;"> 
    <div class="row">
        <div class="col-12">
            <div class="block">
                <div class="block-body row">
                    <div class="form-group col-4">
                        <label class="form-control-label">Fecha Inicio</label>
                        <input id="date1" type="text" class="form-control input-datepicker-autoclose">
                      </div>
                    <div class="form-group col-4">
                      <label class="form-control-label">Fecha Fin</label>
                      <input id="date2" type="text" class="form-control input-datepicker-autoclose">
                    </div>
                    <div class="form-group col-2">
                        <label class="form-control-label"></label>
                        <button id="date" style="color:#fff;" type="button" class="form-control btn-primary"> Buscar </button>
                      </div>
                    <div class=" form-groupcol-2">
                        <label class="form-control-label"></label>
                        <button id="export" type="button" style="color:#fff;" class="form-control btn-secondary"> Exportar </button>
                      </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="block">
                <div class="table-responsive">
                    <table id="table" class="table zero-configuration">
                        <thead>
                            <tr>
                                <th>ph</th>
                                <th>tds</th>
                                <th>turbidez</th>
                                <th>temperatura </th>
                                <th>conductividad</th>
                                <th>fecha</th>
                            </tr>
                        </thead>
                        <tbody>
                            
                        </tbody>
                        <tfoot>
                            <tr>
                                <th>ph</th>
                                <th>tds</th>
                                <th>turbidez</th>
                                <th>temperatura </th>
                                <th>conductividad</th>
                                <th>fecha</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>    
</div>
 


<script type="text/javascript" src= "{% static 'vendor/datatables/datatable_boostrap.js' %}" defer > </script>
<script type="text/javascript" src= "{% static 'vendor/datatables/datatable_responsive_boostrap.js' %}" defer > </script>
<script type="text/javascript" src= "{% static 'vendor/datatables/datatable_responsive_min.js' %}" defer > </script>
<script type="text/javascript" src= "{% static 'vendor/datatables/tables_datatables.js' %}" defer > </script>

<script  type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js" ></script>
<script type="text/javascript" src= "{% static 'vendor/datatables/datatable_jquery.js' %}" defer > </script>
<script type="text/javascript" src= "{% static 'js/datepick/datepicker.js' %}" > </script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="text/javascript">
var $j = jQuery.noConflict();
var table=null
var obj = this
$j(document).ready(function() {

    // $('#date1').datepicker({ dateFormat: 'yy/mm/dd' });
    var date = new Date()
    $j('#date1').datepicker({dateFormat:'dd,mm,yy'}).datepicker('setDate', date)
    $j('#date2').datepicker({dateFormat:'dd,mm,yy'}).datepicker('setDate', date)
    // $j('#date1').datepicker('setDate', 'today');
// $j('#date2').datepicker('setDate', 'today');
   
});

 
 function setDataTable(data,action){
    if (action =="set"){
        obj.table = $('#table').DataTable({
        "columns": [
        {"data": "ph", "searchable": true, "orderable":true},
        {"data": "tds", "searchable": true, "orderable":true},
        {"data": "turbidez", "searchable": true, "orderable":true},
        {"data": "temperatura", "searchable": true, "orderable":true},
        {"data": "conductividad", "searchable": true, "orderable":true},
        {"data": "fecha", "searchable": true, "orderable":true},
        ],
        "order": [[ 5, "desc" ]],
        data: data,
        "language": {
            "url": "//cdn.datatables.net/plug-ins/9dcbecd42ad/i18n/Spanish.json"
        }
        });
    }else{
        obj.table.clear().draw();
    }
    
 }



$j( "#date" ).click(function() {
  var fecha_inicio = $j('#date1').val();
  var fecha_fin = $j('#date2').val();


  var date1 =  new Date (fecha_inicio);
  var date2 =  new Date (fecha_fin);
  var fecha1 = date1.getDate()+ "-"+ (date1.getMonth()+1) +"-"+ date1.getFullYear();
  var fecha2 = date2.getDate()+ "-"+ (date2.getMonth()+1) +"-"+ date2.getFullYear();
    // console.log(fecha1)


    fetch('/api/report/data?date_start='+fecha1+'&date_end='+fecha2)
    .then((resp) => resp.json())
    .then(function(data) {
        if(data.code==1){
            setDataTable(data.data,"set")
        }else{
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'No se encontraron mediciones en este rango de fechas!',

            })
            setDataTable(data.data,"clean")
        }
        
    })
    .catch(function(error) {
    // console.log(error);
    });
})


$j( "#export" ).click(function() {
  var fecha_inicio = $j('#date1').val();
  var fecha_fin = $j('#date2').val();
  var date1 =  new Date (fecha_inicio);
  var date2 =  new Date (fecha_fin);
  var fecha1 = date1.getDate()+ "-"+ (date1.getMonth()+1) +"-"+ date1.getFullYear();
  var fecha2 = date2.getDate()+ "-"+ (date2.getMonth()+1) +"-"+ date2.getFullYear();

    fetch('/api/report/data?date_start='+fecha1+'&date_end='+fecha2+'&export=xls')
    .then(response => response.blob())
    .then(blob => URL.createObjectURL(blob))
    .then(uril => {
    var link = document.createElement("a");
    link.href = uril;
    link.download = "reporte.xlsx";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    })
    .catch(function(error) {
    });
})

</script>


{% endblock %}